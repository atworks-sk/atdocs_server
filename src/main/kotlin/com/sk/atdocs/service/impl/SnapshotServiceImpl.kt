package com.sk.atdocs.service.implimport com.github.javaparser.StaticJavaParserimport com.github.javaparser.ast.CompilationUnitimport com.github.javaparser.ast.Nodeimport com.github.javaparser.ast.body.MethodDeclarationimport com.github.javaparser.ast.body.VariableDeclaratorimport com.github.javaparser.ast.expr.Expressionimport com.github.javaparser.ast.expr.MethodCallExprimport com.sk.atdocs.app.enum.CodeGroupimport com.sk.atdocs.app.exception.SnapshotErrorCodeimport com.sk.atdocs.domain.entity.*import com.sk.atdocs.domain.repository.SnapshotErrorRepositoryimport com.sk.atdocs.domain.repository.SnapshotRepositoryimport com.sk.atdocs.dto.clazz.ClazzElementDtoimport com.sk.atdocs.dto.etl.ScopeDtoimport com.sk.atdocs.dto.snapshot.SearchListReqDtoimport com.sk.atdocs.dto.snapshot.SnapshotDtoimport com.sk.atdocs.service.*import mu.KotlinLoggingimport org.springframework.data.domain.Pageimport org.springframework.data.domain.Pageableimport org.springframework.data.jpa.domain.Specificationimport org.springframework.stereotype.Serviceimport org.springframework.transaction.annotation.Transactionalimport java.io.Fileprivate val logger = KotlinLogging.logger {  }@Serviceclass SnapshotServiceImpl(    var snapshotRepository: SnapshotRepository,    var snapshotErrorRepository : SnapshotErrorRepository,    var projectService: ProjectService,    var clazzService: ClazzService,    var codeService: CodeService):SnapshotService {    /*     * snapshot list search     */    @Transactional(readOnly = false)    override fun searchList(reqDto: SearchListReqDto, pageable: Pageable): Page<SnapshotDto>? {        // project id equal        fun equalProjectId(projectId: Long?): Specification<SnapshotEntity> {            return Specification<SnapshotEntity> { root, query, builder ->                projectId?.let {                    builder.equal(root.get<Any>("project")!!.get<Any>("id"), it)                }                        ?: null            }        }        var entities = snapshotRepository.findAll(equalProjectId(reqDto.projectId)                , pageable)        return entities.map { snapshotEntity: SnapshotEntity? ->            SnapshotDto(snapshotEntity!!)        }    }    @Transactional(readOnly = false)    override fun deleteSnapshot(id: Long) {        snapshotRepository.delete(snapshotRepository.findById(id).get())    }    /*     * 자바 소스를 분석/번역 시스템     */    @Transactional(readOnly = false)    override fun CreateSnapshot(path: String, projectId: Long): Boolean {        // TODO 이내용을 커스터마이징으로 뺴야될것 같습니다.        val rootDir = File(path)        if(!rootDir.exists())            return false        // Snapshot 생성합니다.        var project = projectService.findById(projectId)        var snapshot = snapshotRepository.save(SnapshotEntity(project, path))        logger.info { "프로젝트 명 : " + project.projectName }        logger.info { "Snapshot ID : " + snapshot.id }        logger.info { "클래스 정보를 등록합니다." }        getDirectory(rootDir, snapshot, "CLASS")        logger.info { "클래스 정보 등록이 끝났습니다." }        logger.info { "매서드 정보를 등록합니다." }        try{            getDirectory(rootDir, snapshot, "METHOD")        }catch (e:RuntimeException){            e.printStackTrace()        }        logger.info { "매서드 정보 등록이 끝났습니다." }        logger.info { "매서드 연관정보를 등록합니다." }//        getDirectory(rootDir, snapshot, "CALL")        logger.info { "매서드 연관정보 등록이 끝났습니다." }        return false    }    /*     * directory search     */    fun getDirectory(dir:File, snapshot: SnapshotEntity, type : String) {        if( (!dir.exists() || dir.isFile) && dir.listFiles().isEmpty()) {            return        }        dir.listFiles().forEach { file: File ->            if(file.isDirectory){                getDirectory(file, snapshot, type)            }            else {                val fileName = file.name                var clazzName = fileName.substring(0, fileName.lastIndexOf("."))                val ext = fileName.substring(fileName.lastIndexOf(".") + 1)                if( "java" != ext){                    // 동일한 SNAPSHOT, FILE 은 1번식만 들어가게 처리함                    updateSnapshotError(snapshot, SnapshotErrorCode.ERROR_NOT_JAVA_FILE, file.absolutePath)                    return                }                var cu : CompilationUnit? = null                try{                    cu = StaticJavaParser.parse(file)                    if(cu.packageDeclaration.isEmpty){                        updateSnapshotError(snapshot, SnapshotErrorCode.ERROR_FAIL_PARSE, file.absolutePath)                        return                    }                }                catch(e : RuntimeException){                    updateSnapshotError(snapshot, SnapshotErrorCode.ERROR_FAIL_PARSE, file.absolutePath)                    return                }                if("CLASS" == type){                    setClazzInfo(cu!!, snapshot, clazzName, file.absolutePath  )                }                else if("METHOD" == type){                    // 등록된 Clazz 객체를 찾습니다.                    clazzService.searchClazzByFilePath(snapshot, file.absolutePath)?.let {                        // 등록된 클래스가 없는 경우 예외처리                        if(it.isEmpty){                            updateSnapshotError(snapshot, SnapshotErrorCode.ERROR_SEARCH_CLAZZ,file.absolutePath)                            return                        }                        setMethodInfo(cu, it.get())                    }                }                else if("CALL" == type){                    // 등록된 Clazz 객체를 찾습니다.                    clazzService.searchClazzByFilePath(snapshot, file.absolutePath)?.let {                        // 등록된 클래스가 없는 경우 예외처리                        if(it.isEmpty){                            updateSnapshotError(snapshot, SnapshotErrorCode.ERROR_SEARCH_CLAZZ,file.absolutePath)                            return                        }                        setCallInfo(cu, it.get())                    }                }            }        }    }    /*     * Clazz 정보 등록     */    private fun setClazzInfo(        cu:CompilationUnit,        snapshot: SnapshotEntity,        clazzName : String,        fullPath : String    ) {        val packageName = cu.packageDeclaration?.get()?.nameAsString        var line = cu.range.get().end.line.toLong()        var comment = if(cu.types[0].comment.isEmpty) "" else cu.types[0].comment?.get()?.content?.toString()        var clazz =  clazzService.saveClazz(                ClazzEntity(snapshot, packageName!!, clazzName, line, fullPath, comment)        )        // clazz annotation list        cu.types.forEach { type ->            type.annotations.forEach { annotation ->                var param1 = if(annotation.childNodes.size > 1) annotation.childNodes[1].toString() else ""                var param2 = if(annotation.childNodes.size > 2) annotation.childNodes[2].toString() else ""                var annotationName = annotation.name.toString()                clazz.annotationList?.add(                    ClazzAnnotationEntity(                        clazz.snapshot,                        clazz,                        annotation.tokenRange.get().toString(),                        annotationName,                        param1,                        param2                    )                )            }        }        cu.types[0].isClassOrInterfaceDeclaration.apply {            if(this){                if(cu.types[0].asClassOrInterfaceDeclaration().isInterface){                    clazz.fileTypeCd = codeService.findByCode(CodeGroup.FILE_TYPE.value, "Interface")                    return                }                else{                    clazz.fileTypeCd = codeService.findByCode(CodeGroup.FILE_TYPE.value, "Class")                }            }            else{                clazz.fileTypeCd = codeService.findByCode(CodeGroup.FILE_TYPE.value, "Enum")                return            }        }        // TODO 이부분 추후 커스터마이징 영역으로 제외해야됩니다.        if(!clazz.annotationList?.filter {            it.annotationName == "RestController" || it.annotationName == "Controller"        }.isNullOrEmpty()){            clazz.clazzTypeCd = codeService.findByCode(CodeGroup.CLAZZ_TYPE.value, "Controller")            return        }        if(!clazz.annotationList?.filter {            it.annotationName == "Repository"        }.isNullOrEmpty()){            clazz.clazzTypeCd = codeService.findByCode(CodeGroup.CLAZZ_TYPE.value, "Repository")            return        }        if(!clazz.annotationList?.filter {            it.annotationName == "Entity"        }.isNullOrEmpty()){            clazz.clazzTypeCd = codeService.findByCode(CodeGroup.CLAZZ_TYPE.value, "Entity")            return        }        if(!clazz.annotationList?.filter {            it.annotationName == "Data" || it.annotationName == "Getter"        }.isNullOrEmpty()){            clazz.clazzTypeCd = codeService.findByCode(CodeGroup.CLAZZ_TYPE.value, "Data")            return        }    }    private fun getMethodInfo(clazz: ClazzEntity, method: MethodDeclaration): MethodEntity? {        // 메서드명과 파라매터 갯수로 비교        var methodList = clazz.methodList?.filter {            it.methodName == method.nameAsString && it.methodParamList?.size ?: 0 == method.parameters.size ?: 0        }        if(methodList?.size == 1){            return methodList[0]        }        // expression 표현식으로 찾도록 하자        var temp = method.parameters.map {            it.type.toString()        }//        methodList = methodList?.filter {//            it.methodParamList?.map {//                it.elementText//            } == temp//        }        if(methodList?.size == 1){            return methodList[0]        }        if(method.type.toString() == ""){            methodList = methodList?.filter {                it.methodReturnList?.size == 0            }            if(methodList?.size == 1){                return methodList[0]            }        }        // 리턴데이터까지 확인합니다.//        methodList = methodList?.filter {//            it.methodReturnList?.get(0)?.elementText == method.type.toString()//        }        if(methodList?.size == 1){            return methodList[0]        }        return null    }    private fun setCallInfo(cu: CompilationUnit, clazz: ClazzEntity) {        //Method 정보 등록        cu.types.forEach { type ->            type.methods.forEach { method ->                var methodEntity : MethodEntity? = getMethodInfo(clazz, method)                logger.info { methodEntity?.methodName }                val results: List<MethodCallExpr> = method.findAll(MethodCallExpr::class.java)                logger.info { methodEntity?.methodName }            }        }    }    /*     * 클래스 상세 정보 세팅     */    private fun setMethodInfo(cu: CompilationUnit, clazz: ClazzEntity) {        /*         * clazz import 정보 저장 ( import clazz 객체까지 연동됨 )         */        cu.imports.forEach { import ->            var clazzImportName = import.name?.toString()            clazzService.searchClazzByClazzFullName(clazz.snapshot, clazzImportName!!)?.let {                clazz.importList?.add(                    ClazzImportEntity(                        clazz.snapshot,                        clazz,                        clazzImportName,                        if(it.isEmpty) null else it.get()                    )                )            }        }        cu.types[0].isClassOrInterfaceDeclaration.apply {            if (this) {                cu.types[0].asClassOrInterfaceDeclaration().extendedTypes.forEach { extneds ->                    var clazzName = extneds.name.toString()                    var clazzData : ClazzElementDto = getClazzInfo(clazz, clazzName)                    clazz.inheritanceList?.add(                        ClazzInheritanceEntity(                            clazz.snapshot,                            clazz,                            clazzName,                            clazzData.packageName,                            codeService.findByCode(CodeGroup.INHERITANCE_TYPE.value, "Extends"),                            clazzData.clazz                        )                    )                }                cu.types[0].asClassOrInterfaceDeclaration().implementedTypes.forEach { implements ->                    var clazzName = implements.name.toString()                    var clazzData : ClazzElementDto = getClazzInfo(clazz, clazzName)                    clazz.inheritanceList?.add(                        ClazzInheritanceEntity(                            clazz.snapshot,                            clazz,                            clazzName,                            clazzData.packageName,                            codeService.findByCode(CodeGroup.INHERITANCE_TYPE.value, "Implements"),                            clazzData.clazz                        )                    )                }            }        }//        cu.types[0].asClassOrInterfaceDeclaration().implementedTypes        cu.types.forEach { type ->            // 클래스 전역 변수 세팅            type.fields.forEach{ field ->                // val fieldDeclaration: List<FieldDeclaration> = type.findAll(FieldDeclaration::class.java)                field.variables.forEach { variable ->                    // Object key1, key2 = ??                    // ClazzFieldEntity                    var comment = if(field.comment.isEmpty) "" else field.comment?.get()?.content?.toString()                    var clazzFieldEntity = ClazzFieldEntity(                        clazz.snapshot,                        clazz,                        field.accessSpecifier.toString(),                        variable.nameAsString,                        variable.typeAsString,                        comment,                        field.toString()                    )                    // 클래스 전역 변수 Type 세팅 (ClazzFieldTypeEntity)                    // method filed types 정보 입력                    if(variable.type.childNodes.size == 0){                        clazzFieldEntity.typeList?.add(                            ClazzFieldTypeEntity(                                clazzFieldEntity.snapshot,                                clazzFieldEntity,                                variable.typeAsString,                                null,                                null,                                null                            )                        )                    }                    else{                        setClazzFieldTypeEntity(clazzFieldEntity, variable.type.childNodes, null)                    }                    clazz.filedList?.add( clazzFieldEntity )                }            }            //Method 정보 등록            type.methods.forEach { method ->                var comment = if(method.comment.isEmpty) "" else method.comment?.get()?.content?.toString()                var methodEntity = MethodEntity(                        method.nameAsString,                        method.accessSpecifier.toString(),                        method.typeAsString,                        method.range.get().end.line.toLong()-method.range.get().begin.line.toLong(),                        method.toString(),                        comment,                        clazz.snapshot,                        clazz                )                // Method Return List Setting                if(method.type.childNodes.size < 1){                    methodEntity.methodReturnList?.add(                        MethodReturnEntity(                            methodEntity.snapshot,                            methodEntity,                            method.typeAsString,                            null,                            null,                            null                        )                    )                }                else{                    setMethodReturn(methodEntity, method.type.childNodes, null)                }                // method parameter setting                method.parameters.forEach { param ->                    var methodParamEntity = MethodParamEntity(                        methodEntity.snapshot,                        methodEntity,                        param.nameAsString,                        param.typeAsString                    )                    // method param type setting (MethodParamTypeEntity)                    if(param.type.childNodes.size == 0){                        methodParamEntity.typeList?.add(                            MethodParamTypeEntity(                                methodParamEntity.snapshot,                                methodParamEntity,                                param.typeAsString,                                null,                                null,                                null                            )                        )                    }                    else{                        setMethodParamTypeEntity(methodParamEntity, param.type.childNodes, null)                    }                    methodEntity.methodParamList?.add(methodParamEntity)                }                // method parameter setting////                var variableDeclarator : List<VariableDeclarator> = method.findAll(VariableDeclarator::class.java)                // Method Filed 정보 입력                method.findAll(VariableDeclarator::class.java).forEach{                    var methodFieldEntity = MethodFieldEntity(                        clazz.snapshot,                        methodEntity,                        it.nameAsString,                        it.typeAsString,                        if(it.initializer.isPresent) it.initializer?.get()?.toString() else null                    )                    // method filed types 정보 입력                    if(it.type.childNodes.size == 0){                        methodFieldEntity.typeList?.add(                            MethodFieldTypeEntity (                                methodFieldEntity.snapshot,                                methodFieldEntity,                                it.typeAsString,                                null, //   packagePath                                null, // myClazz                                null //  parent                            )                        )                    }                    else{                        setMethodFiledTypeEntity(methodFieldEntity, it.type.childNodes, null)                    }                    methodEntity.filedList?.add(methodFieldEntity)                }                // 메서드 호출 관계//                val methodCallExpr: List<MethodCallExpr> = method.findAll(MethodCallExpr::class.java)                method.findAll(MethodCallExpr::class.java).forEach{ methodCall ->                    val scope = if (methodCall.scope.isPresent) methodCall.scope.get().toString() else null                    var methodCallEntity = MethodCallEntity(                        methodEntity.snapshot,                        methodEntity,                        scope,                        methodCall.nameAsString,                        methodCall.arguments.size                    )                    methodCall.arguments.forEach {                        methodCallEntity.argList?.add(                            MethodCallArgEntity(                                methodCallEntity.snapshot,                                methodCallEntity,                                if(it.toString().length > 255) null else it.toString()                            )                        )                    }                    methodEntity.callList?.add(methodCallEntity)                }                clazz.methodList?.add( methodEntity )            }        }    }    /*     * MethodReturn setting function     */    private fun setMethodReturn (methodEntity: MethodEntity, node: List<Node>, parent: MethodReturnEntity?){        var name = node[0].toString()        var clazzData : ClazzElementDto = getClazzInfo(methodEntity.clazz, name)        var thisNode = MethodReturnEntity (            methodEntity.snapshot,            if(parent == null) methodEntity else null,            name,            clazzData.packageName, //   packagePath            clazzData.clazz, // myClazz            parent        )        if(parent == null){            methodEntity.methodReturnList?.add(thisNode)        }        else{            parent.children?.add(thisNode)        }        if(node.size == 1) return        var isFirst : Boolean = true        node.forEach { it ->            if(isFirst){                isFirst = false            }            else{                if(it.childNodes?.size == 0){                    var clazzData2 : ClazzElementDto = getClazzInfo(methodEntity.clazz,it.toString())                    thisNode.children?.add(                        MethodReturnEntity (                            methodEntity.snapshot,                            null,                            it.toString(),                            clazzData2.packageName, //   packagePath                            clazzData2.clazz, // myClazz                            thisNode                        )                    )                    return                }                setMethodReturn(methodEntity, it.childNodes, thisNode)            }        }    }    /*     * MethodParamType setting function     */    private fun setMethodParamTypeEntity (methodParamEntity: MethodParamEntity, node: List<Node>, parent: MethodParamTypeEntity?){        var name = node[0].toString()        var clazzData : ClazzElementDto = getClazzInfo(methodParamEntity.method.clazz, name)        var thisNode = MethodParamTypeEntity (            methodParamEntity.snapshot,            if(parent == null) methodParamEntity else null,            name,            clazzData.packageName, //   packagePath            clazzData.clazz, // myClazz            parent        )        if(parent == null){            methodParamEntity.typeList?.add(thisNode)        }        else{            parent.children?.add(thisNode)        }        if(node.size == 1) return        var isFirst : Boolean = true        node.forEach { it ->            if(isFirst){                isFirst = false            }            else{                if(it.childNodes?.size == 0){                    var clazzData2 : ClazzElementDto = getClazzInfo(methodParamEntity.method.clazz,it.toString())                    thisNode.children?.add(                        MethodParamTypeEntity (                            methodParamEntity.snapshot,                            null,                            it.toString(),                            clazzData2.packageName, //   packagePath                            clazzData2.clazz, // myClazz                            thisNode                        )                    )                    return                }                setMethodParamTypeEntity(methodParamEntity, it.childNodes, thisNode)            }        }    }    /*     * ClazzFieldType setting function     */    private fun setClazzFieldTypeEntity (clazzFieldEntity : ClazzFieldEntity, node: List<Node>, parent: ClazzFieldTypeEntity?){        var name = node[0].toString()        var clazzData : ClazzElementDto = getClazzInfo(clazzFieldEntity.clazz, name)        var thisNode = ClazzFieldTypeEntity (            clazzFieldEntity.snapshot,            if(parent == null) clazzFieldEntity else null,            name,            clazzData.packageName, //   packagePath            clazzData.clazz, // myClazz            parent        )        if(parent == null){            clazzFieldEntity.typeList?.add(thisNode)        }        else{            parent.children?.add(thisNode)        }        if(node.size == 1) return        var isFirst : Boolean = true        node.forEach { it ->            if(isFirst){                isFirst = false            }            else{                if(it.childNodes?.size == 0){                    var clazzData2 : ClazzElementDto = getClazzInfo(clazzFieldEntity.clazz,it.toString())                    thisNode.children?.add(                        ClazzFieldTypeEntity (                            clazzFieldEntity.snapshot,                            null,                            it.toString(),                            clazzData2.packageName, //   packagePath                            clazzData2.clazz, // myClazz                            thisNode                        )                    )                    return                }                setClazzFieldTypeEntity(clazzFieldEntity, it.childNodes, thisNode)            }        }    }    /*     * MethodFieldType setting function     */    private fun setMethodFiledTypeEntity (methodFieldEntity : MethodFieldEntity, node: List<Node>, parent: MethodFieldTypeEntity?){        var name = node[0].toString()        var clazzData : ClazzElementDto = getClazzInfo(methodFieldEntity.method.clazz, name)        var thisNode = MethodFieldTypeEntity (            methodFieldEntity.snapshot,            if(parent == null) methodFieldEntity else null,            name,            clazzData.packageName, //   packagePath            clazzData.clazz, // myClazz            parent        )        if(parent == null){            methodFieldEntity.typeList?.add(thisNode)        }        else{            parent.children?.add(thisNode)        }        if(node.size == 1) return        var isFirst : Boolean = true        node.forEach { it ->            if(isFirst){                isFirst = false            }            else{                if(it.childNodes?.size == 0){                    var clazzData2 : ClazzElementDto = getClazzInfo(methodFieldEntity.method.clazz,it.toString())                    thisNode.children?.add(                        MethodFieldTypeEntity (                            methodFieldEntity.snapshot,                            null,                            it.toString(),                            clazzData2.packageName, //   packagePath                            clazzData2.clazz, // myClazz                            thisNode                        )                    )                    return                }                setMethodFiledTypeEntity(methodFieldEntity, it.childNodes, thisNode)            }        }    }    private fun getClazzInfo (clazz: ClazzEntity, elementClazzName : String) : ClazzElementDto{        var clazzImportData =  clazz.importList?.filter {            it.clazzName == elementClazzName        }        if(clazzImportData?.size == 1){            return ClazzElementDto(                clazzImportData[0].importClazz,                clazzImportData[0].packageName,                clazzImportData[0].clazzName            )        }        else{            // package 내에서 찾아야 됨            var fullName = "${clazz.packageName}.$elementClazzName"            clazzService.searchClazzByClazzFullName(clazz.snapshot, fullName)?.let {                if(!it.isEmpty) {                    ClazzElementDto(                        it.get(),                        it.get().packageName,                        it.get().clazzName                    )                }            }        }        return ClazzElementDto(            null,            "".toString(),            elementClazzName        )    }    /*     * 스냅샷 등록시 오류건을 테이블에 기록합니다.     */    private fun updateSnapshotError(snapshot : SnapshotEntity, snapshotErrorCode : SnapshotErrorCode, filePath : String) {        if(snapshotErrorRepository.findBySnapshotAndFilePath(snapshot, filePath)?.isEmpty == true){            snapshot.snapshotErrorList?.add(                SnapshotErrorEntity( snapshot, snapshotErrorCode, filePath )            )        }    }}